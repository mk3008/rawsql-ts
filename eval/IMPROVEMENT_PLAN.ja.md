# ztd-cli 自己反復 改善計画書

## 目的

`ztd-cli init` を起点として、
**SQL（DDL を含む）を修正の一次起点とした開発環境を構築する**。

* SQL / DDL を変更すると、必要な検証・整合性調整が機械的に実行される
* 人間は「何を変更したか」を指示するだけとし、辻褄合わせはツールとAIが担当する
* init 直後から、この自己反復ループが回ることをゴールとする

---

## 基本哲学

### SQL / DDL の位置づけ

* SQL は **仕様書** であり **ドメイン要求そのもの**
* DDL / SQL の意味・意図の主幹は **人間**
* AI は **補助** であり、意味や意図の推測は禁止

### 境界定義（インターフェイス）

* DTO・Repository などの **インターフェイス境界定義** の主幹は人間
* AI は整合性調整・機械的更新のみを行う

### テストと検証

* SQL は ZTD（DDL + fixtures）を用い、**実 Postgres を使った単体テスト**を行う
* SQL は mapper を含めて **カタログとして一元管理**する
* 粒度の細かい整合性から順に検証し、上位へ積み上げる

### 修正の考え方

* 指示は「X を変更したので辻褄を合わせてほしい」という形式を基本とする
* ドメイン設計の再発明は禁止
* 機械的に直せるものは、必ず機械的に直す

---

## AI の行動指針（重要）

* タスクは **必ず上から順に処理する**
* 未完了の項目を飛ばして次に進んではならない
* 1反復で適用する変更は **1件のみ**
* コーディングよりも **問題の切り分けと構造化** を優先する
* 修正はツール・スクリプト・自動生成を第一選択とする
* エラーメッセージ、ディレクトリ構造、補助ツールの新設・改善は許可
* 必要であれば rawsql-ts 自体の機能強化も許可

### やらないこと

* SQL の意味変更
* スキーマ設計の再構築
* 広範囲なリファクタリング
* 人間の意図を推測した修正

---

## 変更案の扱い（スタックと効果検証）

* 改善案は **提案スタック** に積む
* 反復ではスタックから **必ず1件だけ** 選んで実行する
* 実行後は必ず **効果検証** を行う
* 効果が無い場合は **「無駄だったナレッジ」** として記録し、同種提案を繰り返さない

### 効果検証の最低要件

各反復で次を必ず記録する。

* 変更内容
* 期待した効果
* 観測結果（事実のみ）
* 判定: 有効 / 無効 / 保留
* 無効の場合: 無駄ナレッジ（理由1行）

---

## 完了条件（提案枯渇ベース）

反復の終了条件は以下とする。

* 新規の **重大な改善提案が出なくなった**
* 出る提案が **軽微** または **誤差** の範囲に収まった

### 同一項目反復の上限

* 同一項目に対する反復は **最大3回まで**
* 3回を超えても改善提案が出続ける場合は、**人間の判断をあおぐ**
* 人間判断が入るまで、その項目の反復は停止する

---

## 提案カテゴリと評価基準

### 共通: 誤差の定義

* 誤差: 個人の好みであり、失敗率 / 探索性 / 再現性 / 機械化のどれも改善しない提案

---

### 1. 機械化

* 方針: 枯れるまで対応
* 重大:

  * 同種の問題を恒久的に減らすツール・スクリプト
* 軽微:

  * 便利だが無くても困らない補助
* 誤差:

  * 運用に影響しない自動化

終了条件:

* 新規の有効な機械化案が出なくなった

---

### 2. エラーメッセージ改善

* 十分条件:

  * 意味のある事実が書かれている
  * 次に打つべきコマンドが明示されている
* 方針:

  * 推論は人間の仕事
  * AIは事実と観測の整理まで

終了条件:

* 主要な失敗カテゴリで事実と次コマンドが揃った

---

### 3. フォルダ構成 / アーキテクチャ

* 方針: 枯れるまで対応
* 誤差条件:

  * 探索性の改善が測定できない
  * 移動コストに対して効果が不明瞭

終了条件:

* 明確な探索性改善案が出なくなった

---

### 4. AGENTS.md ブラッシュアップ

* 方針: 永久反復を防ぐため、原則誤差扱い
* 重大:

  * 思想・哲学に反する挙動をAIが行い、再発防止が必要
* 軽微:

  * 例示追加、表現改善、再整理
* 取り扱い:

  * 重大以外は原則採用しない
  * 採用しても必ず効果検証を行い、無効なら無駄ナレッジ化

終了条件:

* 重大なAGENTS改善案が出なくなった

---

## 改善タスクリスト（進捗台帳）

### [ ] 1. SQLカタログ単体テストの改善（ZTD / Mapping）

### [ ] 2. ZTD 実行環境の安定化（DDL / fixtures）

### [ ] 3. DDL変更に伴う整合性調整

### [ ] 4. SQL変更に伴う整合性調整

### [ ] 5. DTO変更に伴う整合性調整

（各項目の詳細・成果・観測・質問はこのファイルに追記する）

---

## 反復記録テンプレート（追記用）

* Iteration: N

* Target item:

* Change applied:

* Expected effect:

* Observed effect:

* Verdict: Effective / Ineffective / Pending

* If Ineffective: Waste knowledge:

* Proposal stack:

  * Pending:
  * Dropped as noise:
  * Dropped as waste:

---

## 総括

* 本計画は AI が作業者、人間が判断者という役割分離を前提とする
* 人間は進捗シートを確認し、必要な判断のみを行う
* 無駄だった試行もナレッジとして残し、同じ失敗を繰り返さない
