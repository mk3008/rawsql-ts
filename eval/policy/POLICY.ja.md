# Eval Policy (Fixed)

この文書は eval 運用の固定方針です。反復ログは記載しません。

## ログ保持ポリシー

eval の反復ログ（`eval/logs/**`）は **原則として Git 管理しない**。ただし、`2026-02-11` の移行ログは plan/log 分離の履歴基準として例外的に保持する。今後の新規ログは `eval/logs/iterations/<YYYY-MM-DD>/iter-xxxx.md` と `eval/logs/summary/<YYYY-MM-DD>.md` に追記し、コミット対象にするのは「重大な学びの固定」「再現性に関わる運用変更の根拠」「方針更新時の監査証跡」が必要な場合に限定する。

## 目的

`ztd-cli init` を起点として、
**SQL（DDL を含む）を修正の一次起点とした開発環境を構築する**。

* SQL / DDL を変更すると、必要な検証・整合性調整が機械的に実行される
* 人間は「何を変更したか」を指示するだけとし、辻褄合わせはツールとAIが担当する
* init 直後から、この自己反復ループが回ることをゴールとする

---

## 基本哲学

### SQL / DDL の位置づけ

* SQL は **仕様書** であり **ドメイン要求そのもの**
* DDL / SQL の意味・意図の主幹は **人間**
* AI は **補助** であり、意味や意図の推測は禁止

### 境界定義（インターフェイス）

* DTO・Repository などの **インターフェイス境界定義** の主幹は人間
* AI は整合性調整・機械的更新のみを行う

### テストと検証

* SQL は ZTD（DDL + fixtures）を用い、**実 Postgres を使った単体テスト**を行う
* SQL は mapper を含めて **カタログとして一元管理**する
* 粒度の細かい整合性から順に検証し、上位へ積み上げる

### 修正の考え方

* 指示は「X を変更したので辻褄を合わせてほしい」という形式を基本とする
* ドメイン設計の再発明は禁止
* 機械的に直せるものは、必ず機械的に直す

---

---

## 変更案の扱い（スタックと効果検証）

* 改善案は **提案スタック** に積む
* 反復ではスタックから **必ず1件だけ** 選んで実行する
* 実行後は必ず **効果検証** を行う
* 効果が無い場合は **「無駄だったナレッジ」** として記録し、同種提案を繰り返さない

### 効果検証の最低要件

各反復で次を必ず記録する。

* 変更内容
* 期待した効果
* 観測結果（事実のみ）
* 判定: 有効 / 無効 / 保留
* 無効の場合: 無駄ナレッジ（理由1行）

---

## 完了条件（提案枯渇ベース）

反復の終了条件は以下とする。

* 新規の **重大な改善提案が出なくなった**
* 出る提案が **軽微** または **誤差** の範囲に収まった

### 同一項目反復の上限

* 同一項目に対する反復は **最大3回まで**
* 3回を超えても改善提案が出続ける場合は、**人間の判断をあおぐ**
* 人間判断が入るまで、その項目の反復は停止する

---

## 提案カテゴリと評価基準

### 共通: 誤差の定義

* 誤差: 個人の好みであり、失敗率 / 探索性 / 再現性 / 機械化のどれも改善しない提案

---

### 1. 機械化

* 方針: 枯れるまで対応
* 重大:

  * 同種の問題を恒久的に減らすツール・スクリプト
* 軽微:

  * 便利だが無くても困らない補助
* 誤差:

  * 運用に影響しない自動化

終了条件:

* 新規の有効な機械化案が出なくなった

---

### 2. エラーメッセージ改善

* 十分条件:

  * 意味のある事実が書かれている
  * 次に打つべきコマンドが明示されている
* 方針:

  * 推論は人間の仕事
  * AIは事実と観測の整理まで

終了条件:

* 主要な失敗カテゴリで事実と次コマンドが揃った

---

### 3. フォルダ構成 / アーキテクチャ

* 方針: 枯れるまで対応
* 誤差条件:

  * 探索性の改善が測定できない
  * 移動コストに対して効果が不明瞭

終了条件:

* 明確な探索性改善案が出なくなった

---

### 4. AGENTS.md ブラッシュアップ

* 方針: 永久反復を防ぐため、原則誤差扱い
* 重大:

  * 思想・哲学に反する挙動をAIが行い、再発防止が必要
* 軽微:

  * 例示追加、表現改善、再整理
* 取り扱い:

  * 重大以外は原則採用しない
  * 採用しても必ず効果検証を行い、無効なら無駄ナレッジ化

終了条件:

* 重大なAGENTS改善案が出なくなった

---

## TASKS運用

### 1) TASKS.md の役割

* `eval/plans/TASKS.md` は人間が与えたタスクの **TODO/DONE 状態管理のみ** を扱う
* 1タスクは1行で管理し、詳細やログ本文は書かない
* ログ/実績は `eval/logs/work/*`、再開は `eval/resume.md`、知見は `eval/knowledge.md` を参照する
* 機械の正は `eval/reports/*` と `eval/tmp/*` とする

### 2) サブタスク追加ルール（AIが可能な範囲）

* AIはサブタスク行（例: `Task0-1`）を追加してよい
* 追加対象は「本題タスクに入る前の割り込み（Task0 eval安定化など）」または「本題実行の前提条件」に限定する
* 追加は進捗可視化に必要な場合のみとする
* 優先度タグは任意とし、目安は `[P0]` 停止回避、`[P1]` 観測確度向上、`[P2]` 運用改善、`[P3]` 便利機能

### 3) DONE更新ルール

* 原則として DONE への更新は人間が行う
* 例外として、観測で完了が明確に確定し、かつ `work report` / `resume` / `knowledge` のいずれかに証拠が残る場合のみAIが更新してよい
* 提案提示のみ・検討のみは DONE にしない

### 4) 1反復1件との整合

* 1反復で実行する改善は常に1件のみとする
* 複数案が出た場合、未実行案は `TASKS.md` にサブタスクとして1行で積む
* 未実行理由は必要に応じて同一行に短く記載してよい（1行厳守）
