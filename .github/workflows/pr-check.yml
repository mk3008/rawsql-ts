name: PR Check

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  quick-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        run_install: false
      
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build ZTD CLI dependencies
      run: |
        pnpm --filter rawsql-ts run build
        pnpm --filter @rawsql-ts/test-evidence-core run build
        pnpm --filter @rawsql-ts/test-evidence-renderer-md run build
        pnpm --filter @rawsql-ts/testkit-core run build
        pnpm --filter @rawsql-ts/ztd-cli run build

    - name: Detect deprecated playground
      id: playground
      run: |
        if [ -d "./playgrounds/ztd-playground" ]; then
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "exists=false" >> "$GITHUB_OUTPUT"
          echo "playgrounds/ztd-playground is removed; skipping playground artifact generation."
        fi

    - name: Generate ZTD artifacts (playground)
      if: steps.playground.outputs.exists == 'true'
      working-directory: ./playgrounds/ztd-playground
      run: node ../../packages/ztd-cli/dist/index.js ztd-config

    - name: Verify working tree is clean after generation
      run: git diff --exit-code
      
    - name: Lint check
      run: pnpm -r run lint
      
    - name: TypeScript compilation check
      run: pnpm -r --workspace-concurrency=1 run build

    - name: Validate test-evidence packages and consumers (dist shape)
      run: |
        pnpm -r --if-present --filter @rawsql-ts/test-evidence-core --filter @rawsql-ts/test-evidence-renderer-md --filter @rawsql-ts/shared-binder --filter @rawsql-ts/testkit-core --filter @rawsql-ts/testkit-postgres --filter @rawsql-ts/adapter-node-pg --filter @rawsql-ts/ztd-cli --filter @rawsql-ts/sql-contract-zod run build
        pnpm -r --if-present --filter @rawsql-ts/test-evidence-core --filter @rawsql-ts/test-evidence-renderer-md --filter @rawsql-ts/shared-binder --filter @rawsql-ts/testkit-core --filter @rawsql-ts/testkit-postgres --filter @rawsql-ts/adapter-node-pg --filter @rawsql-ts/ztd-cli --filter @rawsql-ts/sql-contract-zod run test
      
    - name: Run unit tests (core)
      run: pnpm --filter "./packages/core" run test
      
    - name: Run unit tests (prisma-integration)
      run: echo "prisma-integration removed"

  validate-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        run_install: false
      
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Check package.json validity
      run: |
        pnpm --filter "./packages/core" run build
        mkdir -p tmp
        pnpm pack --filter "./packages/core" --pack-destination ./tmp
        
    - name: Check prisma-integration package
      run: echo "prisma-integration removed"
