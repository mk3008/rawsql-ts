name: PR Check

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  quick-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        run_install: false
      
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build ZTD CLI dependencies
      run: |
        pnpm --filter rawsql-ts run build
        pnpm --filter @rawsql-ts/testkit-core run build
        pnpm --filter @rawsql-ts/ztd-cli run build

    - name: Generate ZTD artifacts (playground)
      working-directory: ./playgrounds/ztd-playground
      run: node ../../packages/ztd-cli/dist/index.js ztd-config

    - name: Verify working tree is clean after generation
      run: git diff --exit-code
      
    - name: Lint check
      run: pnpm -r run lint
      
    - name: TypeScript compilation check
      run: pnpm -r run build
      
    - name: Run unit tests (core)
      run: pnpm --filter "./packages/core" run test
      
    - name: Run unit tests (prisma-integration)
      run: echo "prisma-integration removed"

  validate-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        run_install: false
      
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Check package.json validity
      run: |
        pnpm --filter "./packages/core" run build
        mkdir -p tmp
        pnpm pack --filter "./packages/core" --pack-destination ./tmp
        
    - name: Check prisma-integration package
      run: echo "prisma-integration removed"
