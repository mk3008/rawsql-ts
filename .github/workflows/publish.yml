name: Publish (manual)

on:
  workflow_dispatch:
    inputs:
      auth:
        description: "Authentication method for npm publish"
        required: false
        default: "oidc"
        type: choice
        options:
          - oidc
          - token

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://registry.npmjs.org"

      - run: corepack enable

      - name: Export NODE_AUTH_TOKEN (token auth only)
        if: ${{ inputs.auth == 'token' }}
        shell: bash
        run: |
          TOKEN="${{ secrets.NPM_TOKEN }}"
          if [ -z "${TOKEN}" ]; then
            TOKEN="${{ secrets.NODE_AUTH_TOKEN }}"
          fi

          if [ -z "${TOKEN}" ]; then
            echo "Token auth selected, but no NPM_TOKEN or NODE_AUTH_TOKEN secret was provided."
            exit 1
          fi

          echo "NODE_AUTH_TOKEN=${TOKEN}" >> "${GITHUB_ENV}"

      - run: pnpm install --frozen-lockfile

      - name: Update npm for OIDC
        shell: bash
        run: |
          # npm Trusted Publishing (OIDC) requires npm >= 11.5.1.
          npm install -g "npm@^11.5.1"
          npm --version

      # Safety guard: fail if changesets haven't been versioned yet.
      - name: Fail if there are unapplied changesets
        shell: bash
        run: |
          if ls .changeset/*.md >/dev/null 2>&1; then
            echo "Unapplied changesets exist. Run Release PR first."
            exit 1
          fi

      - name: Verify npm authentication (token path)
        if: ${{ inputs.auth == 'token' }}
        shell: bash
        run: |
          # Fail fast with a clear error when the token is expired/revoked or lacks publish access.
          npm whoami

      - name: Build publish artifacts (dist/)
        run: pnpm build:publish

      - name: Configure git identity for tags
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Publish to npm (OIDC-compatible), tag, and create GitHub Releases
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node ./scripts/ci-publish.mjs
