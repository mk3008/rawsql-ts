name: Publish (manual)

on:
  workflow_dispatch:

concurrency:
  group: publish-npm
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  publish_oidc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - run: corepack enable

      - run: pnpm --version

      - run: pnpm install --frozen-lockfile

      - name: Update npm
        shell: bash
        run: |
          # npm Trusted Publishing (OIDC) requires npm >= 11.5.1.
          npm install -g "npm@^11.5.1"
          npm --version

      # Safety guard: fail if changesets haven't been versioned yet.
      - name: Fail if there are unapplied changesets
        shell: bash
        run: |
          if find .changeset -maxdepth 1 -type f -name '*.md' ! -name 'README.md' | grep -q .; then
            echo "Unapplied changesets exist. Run Release PR first."
            exit 1
          fi

      - name: Build publish artifacts (dist/)
        run: pnpm build:publish

      - name: Configure git identity for tags
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: OIDC diagnostics
        shell: bash
        run: |
          echo "RAWSQL_PUBLISH_AUTH=oidc"
          echo "NPM_CONFIG_PROVENANCE=true"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL:+(set)}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN=${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+(set)}"
          echo "NODE_AUTH_TOKEN=${NODE_AUTH_TOKEN:+(set)}"
          npm --version
          npm config get registry
          npm config get provenance || true
          npm whoami && echo "npm auth: token/session is active (unexpected for pure OIDC)" || echo "npm auth: no token/session (expected for OIDC)"

      - name: Publish to npm (OIDC-compatible), tag, and create GitHub Releases
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: "true"
          RAWSQL_PUBLISH_AUTH: "oidc"
        run: node ./scripts/ci-publish.mjs
